"""
This file contains functions related to generating and analyzing filterbanks.
"""

import scipy.signal
import numpy as np


def generate_complementary_filterbank(
        fc=[125.0, 250.0, 500.0, 1000.0, 2000.0, 4000.0, 8000.0],
        fs=16000,
        filter_order=4,
        filter_length=16384,
        power=True):
    """Return a zero-phase power (or amplitude) complementary filterbank via Butterworth prototypes.
    Parameters:
        fc - filter center frequencies
        fs - sampling rate
        filter_order - order of the prototype Butterworth filters
        filter_length - length of the resulting zero-phase FIR filters
        power - boolean to set if the filter is power or amplitude complementary
    """

    # sort in increasing cutoff
    fc = np.sort(fc)

    assert fc[-1] <= fs/2

    numFilts = len(fc)
    nbins = filter_length
    signal_z1 = np.zeros(2 * nbins)
    signal_z1[0] = 1
    irBands = np.zeros((2 * nbins, numFilts))

    for i in range(numFilts - 1):
        wc = fc[i] / (fs/2.0)
        # if wc >= 1:
        #     wc = .999999

        B_low, A_low = scipy.signal.butter(filter_order, wc, btype='low')
        B_high, A_high = scipy.signal.butter(filter_order, wc, btype='high')


        # Store the low band
        irBands[:, i] = scipy.signal.lfilter(B_low, A_low, signal_z1)

        # Store the high
        signal_z1 = scipy.signal.lfilter(B_high, A_high, signal_z1)

        # Repeat for the last band of the filter bank
    irBands[:, -1] = signal_z1

    # Compute power complementary filters
    if power:
        ir2Bands = np.real(np.fft.ifft(np.square(np.abs(np.fft.fft(irBands, axis=0))), axis=0))
    else:
        ir2Bands = np.real(np.fft.ifft(np.abs(np.abs(np.fft.fft(irBands, axis=0))), axis=0))

    ir2Bands = np.concatenate((ir2Bands[nbins:(2 * nbins), :], ir2Bands[0:nbins, :]), axis=0)

    return ir2Bands



def plot_original_sti_filterbank(fs):
    import acoustics
    import matplotlib.pyplot as plt
    plt.figure()

    center_frequencies = [125, 250.0, 500.0, 1000.0, 2000.0, 4000.0, 8000]
    # fs = 2 * center_frequencies[-1] * np.sqrt(2) + 1

    eps = np.finfo(float).eps

    for fc in center_frequencies:
        f = acoustics.signal.octave_filter(fc, fs, 1.0)
        b, a = scipy.signal.sos2tf(f)
        w, h = scipy.signal.freqz(b, a)

        # plt.semilogx(w, 20 * np.log10(abs(h) + eps), label='octave filter')
        # plt.title('acoustics.signal.octave_filter')
        # plt.xlabel('Frequency [radians / second]')
        # plt.ylabel('Amplitude [dB]')
        # plt.margins(0, 0.1)
        # plt.grid(which='both', axis='both')
        # plt.axvline(100, color='green')  # cutoff frequency
        #
        # # get the low pass
        # wc = (fc * 2 / fs)
        # b, a = scipy.signal.butter(4, [wc / np.sqrt(2), wc * np.sqrt(2)], 'bandpass')
        # w, h = scipy.signal.freqz(b, a)
        ff = np.linspace(0, fs / 2, len(h))

        plt.semilogx(ff, 20 * np.log10(abs(h) + eps), label='direct butterworth')

    plt.title('Filter Frequency Response')
    plt.xlabel('Frequency [Hz]')
    plt.ylabel('Amplitude [dB]')
    plt.grid()
    plt.xlim((100, fs/2))
    plt.ylim((-100, 10))
    plt.show()

def plot_complementary_filterbank(fs, irBands):
    import matplotlib.pyplot as plt

    eps = np.finfo(float).eps

    fft_size = irBands.shape[0]
    Nf = int(fft_size/2)+1

    H = np.abs(np.fft.fft(irBands, n=fft_size, axis=0))

    # Chop negative frequency
    H = H[0:Nf, :]
    f = np.linspace(0, fs / 2, H.shape[0])



    plt.figure()
    plt.plot(f, 20*np.log10(eps+np.sum((H), axis=1)), label='Power Sum')
    for i in range(irBands.shape[1]):
        plt.semilogx(f, 20 * np.log10(eps+abs(H[:, i])), label=str(i))

    plt.legend()
    # plt.xlim((100, fs / 2))
    plt.ylim((-100, 10))
    plt.title('Filter Frequency Response')
    plt.xlabel('Frequency [Hz]')
    plt.ylabel('Amplitude [dB]')
    plt.grid()
    plt.show()

def gammatone_filterbank_16k_100_8000Hz_40(x=None, verbose=False):

    fs = 16000
    a = np.array([[1.00000000000000000000, -7.87344479889575232789, 27.12710171851568574652, -53.41948014029441083039, 65.76148313533437317346, -51.82259616945982116931, 25.52950613796520684673, -7.18825232556717352850, 0.88568244241117788373, ],
        [1.00000000000000000000, -7.86076095618625902972, 27.04373526685687423310, -53.18509964240045917450, 65.39619115604654098206, -51.48183636209790847715, 25.33930979381371528802, -7.12946181834872838579, 0.87792256237633947702, ],
        [1.00000000000000000000, -7.84600838872859274176, 26.94767985439290924887, -52.91774268555631977051, 64.98399073608173637240, -51.10183053651547879781, 25.12995284414943952811, -7.06568398929101437744, 0.86964216577323549817, ],
        [1.00000000000000000000, -7.82886472804505206824, 26.83706031433474237247, -52.61280576372898565296, 64.51874130400267404184, -50.67782798204381577989, 24.89934959616313392416, -6.99646039617518233911, 0.86080765679378357103, ],
        [1.00000000000000000000, -7.80895774102860062982, 26.70973319105026533293, -52.26507342306404524379, 63.99354045697900517098, -50.20452702722198523588, 24.64519053399336456778, -6.92128954736900947609, 0.85138356148891003450, ],
        [1.00000000000000000000, -7.78585756508512449869, 26.56325138256683970894, -51.86865001510784622951, 63.40065082821494968357, -49.67602762707954155985, 24.36492408786767782658, -6.83962356566101981059, 0.84133249037638702106, ],
        [1.00000000000000000000, -7.75906773147139805502, 26.39482535420631137413, -51.41688903815373379302, 62.73142845283702229153, -49.08578651480105037308, 24.05573930726912834643, -6.75086489933877409442, 0.83061511868505222278, ],
        [1.00000000000000000000, -7.72801479425962334346, 26.20128112283789789672, -50.90232233148539364720, 61.97625673309836003000, -48.42657812965029506813, 23.71455056017775575583, -6.65436321023247412398, 0.81919018997120807146, ],
        [1.00000000000000000000, -7.69203635940758623235, 25.97901550647832280561, -50.31659257607898894094, 61.12449186773051934551, -47.69046581344984758744, 23.33798582083579731261, -6.54941261815403308333, 0.80701455024969248608, ],
        [1.00000000000000000000, -7.65036728502604113089, 25.72394956913410624111, -49.65039417313425929024, 60.16442793445269643371, -46.86878943586670942523, 22.92238068488413915702, -6.43524954576797370009, 0.79404322150566031269, ],
        [1.00000000000000000000, -7.60212380158837586208, 25.43148181981947786312, -48.89342974149661813499, 59.08329282968873741311, -45.95217774963337120653, 22.46378099748012147074, -6.31105149130387843570, 0.78022952555960223275, ],
        [1.00000000000000000000, -7.54628528194135395069, 25.09644362002532602673, -48.03439234057655937704, 57.86729011187208726597, -44.93059647741424100786, 21.95795793662514228117, -6.17593716331478326254, 0.76552527182338248046, ],
        [1.00000000000000000000, -7.48167337938290621935, 24.71306051182742535843, -47.06098724549100609238, 56.50170658735194706423, -43.79344646618938696747, 21.40044060342331633251, -6.02896854739179044458, 0.74988102559625824384, ],
        [1.00000000000000000000, -7.40692825370778429317, 24.27492492562692660840, -45.96001183274531598499, 54.97111129443373300774, -42.52973024721502781631, 20.78657267600614133585, -5.86915564563487812677, 0.73324647730356007358, ],
        [1.00000000000000000000, -7.32048162902302124166, 23.77498812522513915724, -44.71751799831017848419, 53.25967834312652371409, -41.12830995875561512776, 20.11160151889897207411, -5.69546484258767371500, 0.71557093757980438919, ],
        [1.00000000000000000000, -7.22052648690807252763, 23.20558250416358347934, -43.31908854435619815604, 51.35167360297526784052, -39.57828461197637182067, 19.37081031692440902248, -5.50683211315038345646, 0.69680398844508995015, ],
        [1.00000000000000000000, -7.10498331443458042145, 22.55848971197524832633, -41.75026693859643245332, 49.23215287202837231462, -37.86951961145487643989, 18.55970628799559563049, -5.30218260458611823083, 0.67689632710811031835, ],
        [1.00000000000000000000, -6.97146302872802081652, 21.82507585330470689655, -39.99718816352912398315, 46.88792566899681446557, -35.99336531528398097635, 17.67428070126847217125, -5.08045849919288272645, 0.65580084620632406178, ],
        [1.00000000000000000000, -6.81722703240640459654, 20.99652247598691801045, -38.04746570163750618576, 44.30884199084649566203, -33.94360252817231327072, 16.71135901416996460966, -4.84065749357443575462, 0.63347400254898189598, ],
        [1.00000000000000000000, -6.63914538218594874053, 20.06419151869805972410, -35.89139350994449273458, 41.48945573383017659808, -31.71764833575812048139, 15.66906142207842478342, -4.58188470052012686295, 0.60987753552084145170, ],
        [1.00000000000000000000, -6.43365487063046881389, 19.02017394554080453872, -33.52351766627147355848, 38.43110263615089650102, -29.31804117392855957291, 14.54739456891283566620, -4.30342125653800700036, 0.58498060587771882890, ],
        [1.00000000000000000000, -6.19672006523181284621, 17.85808520094841966852, -30.94461285916803916507, 35.14439506126372947392, -26.75419289886547957735, 13.34899256877355533391, -4.00481333582289611428, 0.55876243501345501663, ],
        [1.00000000000000000000, -5.92380221657706318439, 16.57418484161318872339, -28.16405256064042816888, 31.65207119331375906768, -24.04433872387090431744, 12.08001742024718261348, -3.68598551169597721255, 0.53121553264220244817, ],
        [1.00000000000000000000, -5.60984371907145185077, 15.16891022278512046739, -25.20247175358444380322, 27.99203209395761149381, -21.21752159973966200823, 10.75121170047240326539, -3.34738227092629081483, 0.50234960510868431616, ],
        [1.00000000000000000000, -5.24927987942132379118, 13.64891973296584737341, -22.09446487951803561600, 24.22024952913136530697, -18.31530339850989363981, 9.37906486014398588225, -2.99014065689729591213, 0.47219623381947684049, ],
        [1.00000000000000000000, -4.83609566870280094264, 12.02972997347303873994, -18.89081284042174857518, 20.41303459797071795379, -15.39269230850736924765, 7.98700147667721971345, -2.61629500553942495600, 0.44081439830834046045, ],
        [1.00000000000000000000, -4.36395364548706510277, 10.33898609048721084491, -15.65936936642070520520, 16.66795129001575404004, -12.51751972320931294291, 6.60641700513595964139, -2.22901082377490755704, 0.40829688325781016145, ],
        [1.00000000000000000000, -3.82643130453447444239, 8.62029603369894203979, -12.48326209108927287161, 13.10251487079766441468, -9.76723143256870152129, 5.27726568688667452278, -1.83283803860263261321, 0.37477754176907873696, ],
        [1.00000000000000000000, -3.21742289789319801940, 6.93734166562440890402, -9.45455094285926023190, 9.84987168892254416619, -7.22188917347815539927, 4.04774281560815296643, -1.43396281014543824917, 0.34043927188188105593, ],
        [1.00000000000000000000, -2.53178352782882098992, 5.37758449932810655980, -6.66116464450488265925, 7.05111112312813048675, -4.95234537429205534664, 2.97241028844241927942, -1.04042035159580947834, 0.30552237763903467016, ],
        [1.00000000000000000000, -1.76632289272829856586, 4.05422274166925866723, -4.16532442327507723689, 4.84487125247565320052, -3.00347124970632872731, 2.10793346173397022625, -0.66220741059788079674, 0.27033270189374425385, ],
        [1.00000000000000000000, -0.92129191488440742575, 3.10403928725249134146, -1.97373812184237529266, 3.35630013995834008966, -1.37458388139606513256, 1.50553426628998332504, -0.31120202383528805523, 0.23524850403104163865, ],
        [1.00000000000000000000, -0.00254321565068935627, 2.67738282027891472126, -0.00510686782026298705, 2.68814041388676372435, -0.00341825694520078802, 1.19952871154445883661, -0.00076266435725351554, 0.20072448411612572872, ],
        [1.00000000000000000000, 0.97542716040721444415, 2.91495789237903224489, 1.92947973668548655723, 2.91397862872738855344, 1.23397999557322224362, 1.19225205637187325891, 0.25515174100422888248, 0.16729061939287265259, ],
        [1.00000000000000000000, 1.98536619310576956110, 3.90518096568097838883, 4.10304405938526883801, 4.06340586568851414029, 2.48957467679410315853, 1.43773590420239893994, 0.44350401341088468987, 0.13554263028003241121, ],
        [1.00000000000000000000, 2.98201750145634258971, 5.61767901750301401620, 6.76333662968707827190, 6.06999842135493494766, 3.86020545111582080722, 1.83001964681268169954, 0.55444495369005997176, 0.10612010298342547387, ],
        [1.00000000000000000000, 3.89606323120264086413, 7.81734830992207285760, 9.90588668841504471629, 8.64188726485953573331, 5.26276863994456522988, 2.20648666624408873460, 0.58423660432887947191, 0.07966795861147221713, ],
        [1.00000000000000000000, 4.62846981680112445900, 9.98608606773222007291, 12.97518263415133787930, 11.06536933814057022119, 6.33370970851237657939, 2.37949422372624619371, 0.53835835947289711889, 0.05677781823045688347, ],
        [1.00000000000000000000, 5.04829256880540810926, 11.32197578596938924989, 14.72375763431126216574, 12.13936484714942132257, 6.49687310519469818360, 2.20441658851980504252, 0.43371225043514854969, 0.03790904968176295187, ],
        [1.00000000000000000000, 5.00035653213056896504, 10.93905988368412174339, 13.67479988618683961477, 10.68419920882386442429, 5.34248053044266590916, 1.66964421363621084993, 0.29817201249963698473, 0.02329634953751683751, ],])
    b = np.array([[-0.00000001743982491524, -0.00000000030543057499, 0.00000015300724765549, -0.00000026623073108073, 0.00000014608612967985, 0.00000000068491375465, -0.00000001580230451904, ],
        [-0.00000002212669943329, -0.00000000250397396438, 0.00000019660702379950, -0.00000033272821182148, 0.00000017697108782051, 0.00000000316975982030, -0.00000001938898622115, ],
        [-0.00000002774005869378, -0.00000000619050270157, 0.00000025016270406506, -0.00000041001576491524, 0.00000020982252569287, 0.00000000732961233468, -0.00000002336851578202, ],
        [-0.00000003482800798726, -0.00000001209503861450, 0.00000031942481394082, -0.00000050486274995394, 0.00000024637496330169, 0.00000001400693439776, -0.00000002802091508457, ],
        [-0.00000004406904541716, -0.00000002133092484016, 0.00000041180253918191, -0.00000062516522331158, 0.00000028788983037353, 0.00000002449785217765, -0.00000003362502816419, ],
        [-0.00000005626383752464, -0.00000003552552090028, 0.00000053649440962985, -0.00000077953157299215, 0.00000033451833531894, 0.00000004071727412370, -0.00000004040908765542, ],
        [-0.00000007252127162682, -0.00000005708136150208, 0.00000070650578459185, -0.00000097953155845210, 0.00000038573575306015, 0.00000006552741916335, -0.00000004863476523435, ],
        [-0.00000009433354919595, -0.00000008948587212241, 0.00000093980380834066, -0.00000124012391078237, 0.00000043955573809582, 0.00000010314336746019, -0.00000005855958179593, ],
        [-0.00000012376600114405, -0.00000013779317211086, 0.00000126177037008724, -0.00000158141745833862, 0.00000049187377308096, 0.00000015977358024285, -0.00000007044109181753, ],
        [-0.00000016370057198045, -0.00000020930288585374, 0.00000170850879606218, -0.00000203074741758853, 0.00000053520321748300, 0.00000024455050879428, -0.00000008451164691673, ],
        [-0.00000021816934190665, -0.00000031450134081336, 0.00000233150067160677, -0.00000262541897571506, 0.00000055664077326179, 0.00000037087103094361, -0.00000010092281737710, ],
        [-0.00000029284085587778, -0.00000046837890485451, 0.00000320446983245810, -0.00000341671726731292, 0.00000053477189126568, 0.00000055835257174219, -0.00000011965726742075, ],
        [-0.00000039571935207284, -0.00000069224434856427, 0.00000443341198903738, -0.00000447563982502969, 0.00000043490376819879, 0.00000083567064882033, -0.00000014038288038969, ],
        [-0.00000053814971481851, -0.00000101617620375042, 0.00000617125426307709, -0.00000590110998659397, 0.00000020174590395296, 0.00000124465191104517, -0.00000016221617291232, ],
        [-0.00000073627604053469, -0.00000148227436453774, 0.00000863945516244350, -0.00000783194111151804, -0.00000025178439819420, 0.00000184617057470696, -0.00000018334982236579, ],
        [-0.00000101315616981161, -0.00000214882146803550, 0.00001215982771803962, -0.00001046427865103652, -0.00000106168277208685, 0.00000272858116415225, -0.00000020046982122139, ],
        [-0.00000140184290156976, -0.00000309534986173889, 0.00001720163261408037, -0.00001407727396575089, -0.00000243901990729646, 0.00000401970976195131, -0.00000020785573967568, ],
        [-0.00000194987912534138, -0.00000442826384778854, 0.00002445135903404045, -0.00001907103591762097, -0.00000470991559082468, 0.00000590373757550803, -0.00000019600212797293, ],
        [-0.00000272587061679208, -0.00000628594375168721, 0.00003491630919813423, -0.00002602305147190005, -0.00000837660483335393, 0.00000864468528933026, -0.00000014952381373120, ],
        [-0.00000382910604192221, -0.00000884075340766271, 0.00005007841410816060, -0.00003577239474068505, -0.00001421068462676945, 0.00001261852158305518, -0.00000004399687417634, ],
        [-0.00000540364021223246, -0.00001229244160899131, 0.00007212243500604365, -0.00004954578434164223, -0.00002339535587824468, 0.00001835601873002781, 0.00000015876830503925, ],
        [-0.00000765888668500697, -0.00001684187010491103, 0.00010427352093887309, -0.00006914650847312743, -0.00003774195112214956, 0.00002659795539215899, 0.00000051774005416290, ],
        [-0.00001089963686192140, -0.00002262376054932438, 0.00015129364718201299, -0.00009723728471846784, -0.00006001830056591751, 0.00003836236801605940, 0.00000112296749755873, ],
        [-0.00001556956827231094, -0.00002955873939691887, 0.00022020450550726994, -0.00013776204182680568, -0.00009444353814889170, 0.00005501885035484563, 0.00000211053178281162, ],
        [-0.00002231368633993384, -0.00003705272771089953, 0.00032132335588142512, -0.00019656966152333745, -0.00014742608877769939, 0.00007835489860372835, 0.00000368390986671677, ],
        [-0.00003206650500753642, -0.00004341709757864530, 0.00046970971060199609, -0.00028232318103692098, -0.00022864664678427893, 0.00011059984717366144, 0.00000614387263172413, ],
        [-0.00004617332109649747, -0.00004479446927964103, 0.00068710326876963534, -0.00040779395736189011, -0.00035260735111996151, 0.00015433670648655622, 0.00000992912360179864, ],
        [-0.00006654964974001437, -0.00003324105440955635, 0.00100434032745778338, -0.00059163290236320654, -0.00054075870425121032, 0.00021217279010017005, 0.00001566919320603384, ],
        [-0.00009587403555388516, 0.00000656231145998360, 0.00146397309450483661, -0.00086063536881886759, -0.00082422302543047111, 0.00028594840214691392, 0.00002424862169148988, ],
        [-0.00013778164640583683, 0.00010267329741379258, 0.00212221519026777354, -0.00125227672597816244, -0.00124684583571956268, 0.00037514045889766313, 0.00003687526152433298, ],
        [-0.00019695866495211844, 0.00030401186187052631, 0.00304813828481012442, -0.00181670438030977145, -0.00186761910986905314, 0.00047399988020719534, 0.00005513212824309687, ],
        [-0.00027888843150961204, 0.00069119198569667290, 0.00431596821178667576, -0.00261610102526668633, -0.00276010889141295153, 0.00056697249129194431, 0.00008096565941395514, ],
        [-0.00038869663739081922, 0.00138727714591464096, 0.00598340852712784654, -0.00371691504795699026, -0.00400400510928947909, 0.00062241746478190654, 0.00011651365681289472, ],
        [-0.00052799005117810049, 0.00255839291188619073, 0.00804646530337731203, -0.00516653185499860602, -0.00566018545287786789, 0.00058626189549311643, 0.00016358724829795544, ],
        [-0.00068778707618551193, 0.00437841723869798315, 0.01036364866225662068, -0.00694136018491940589, -0.00771670593059441481, 0.00038132497103734742, 0.00022246231970738222, ],
        [-0.00083527825400399379, 0.00690595557980111519, 0.01255795839108501434, -0.00885293203933813777, -0.00999163907811819775, -0.00007339794854465134, 0.00028933334911885586, ],
        [-0.00089560429018620421, 0.00979854024233072808, 0.01393484637680865966, -0.01041495343081169471, -0.01197986892973021064, -0.00079407760488270655, 0.00035111763647143840, ],
        [-0.00074813649901013990, 0.01180101595770573913, 0.01342804008245132054, -0.01069886538205339598, -0.01259333050590460447, -0.00156312095521534983, 0.00037439730202642763, ],
        [-0.00030801211106819498, 0.00949965378473437844, 0.00890209457536959500, -0.00769517317826700319, -0.00912124040139256076, -0.00154781553004410249, 0.00027049286066788917, ],
        [0.00022099191145138575, 0.00352898800253927418, 0.00198018297826811716, -0.00362084941077388776, -0.00331971057381554458, -0.00053863444035255744, 0.00009734541350648893, ],])

    if verbose:
        import matplotlib.pyplot as plt
        for i in range(b.shape[0]):
            [w, h] = scipy.signal.freqz( b[i,:], a=a[i,:])
            plt.semilogx(w*(fs/2)/np.pi, 20*np.log10(h))
            plt.xlim(100, fs/2)

    if x is not None:
        y = np.zeros((b.shape[0], x.shape[0]))
        for i in range(b.shape[0]):
            y[i, :] = scipy.signal.lfilter(b[i,:], a[i,:], x)
        return y
    else:
        return b, a



def gammatone_filterbank_16k_400_6000Hz_21(x=None, verbose=False):

    # Coefficients generated from VoiceBox
    #[b, a, fx, bx, gd, ph] = gammabank(21, 16000, 'e', [400 6000]);

    fs = 16000
    a = np.array([
        [1.00000000000000000000, -7.69286766197777627241, 25.98412893947600466049, -50.33001079390230358968, 61.14391993772414224395, -47.70717697356045050583, 23.34648763240772950667, -6.55176551692502329161, 0.80728480718425932317, ],
        [1.00000000000000000000, -7.63233497115140924194, 25.61428994640253975490, -49.36575152997839666114, 59.75674707574673050203, -46.52214267882992260184, 22.74836736818851434805, -6.38791737934549530564, 0.78874355525871064909, ],
        [1.00000000000000000000, -7.55789718023844159234, 25.16582400444525191574, -48.21161534124399850043, 58.11727761041146322896, -45.13987656357170408228, 22.06116910596172075998, -6.20336066968862986926, 0.76848383601344760763, ],
        [1.00000000000000000000, -7.46641128597264991384, 24.62314082481525900903, -46.83406747347694221162, 56.18508073618756526457, -43.53114480850015866054, 21.27256560142228281052, -5.99551568324726602555, 0.74636771533608592399, ],
        [1.00000000000000000000, -7.35402904772431931235, 23.96815694504248739349, -45.19592383004886215758, 53.91675461780328504346, -41.66502879916204449273, 20.36945814940222376777, -5.76159325860556759125, 0.72225353016408244677, ],
        [1.00000000000000000000, -7.21604501898829031603, 23.18026479156026198325, -43.25730684996268848863, 51.26779723462884419405, -39.51041460315803277581, 19.33849230954788467329, -5.49864349556222364868, 0.69599871668815005421, ],
        [1.00000000000000000000, -7.04671786803341237970, 22.23657543733991204249, -40.97758521364998784975, 48.19587091164203940252, -37.03849364856271364488, 18.16694123279988559716, -5.20364600462527882030, 0.66746395007405578959, ],
        [1.00000000000000000000, -6.83906523823407130891, 21.11263902344106924147, -38.31877883968802223080, 44.66602240774221144193, -34.22665919562589920133, 16.84411596288509471719, -4.87366077025582189464, 0.63651904218826227400, ],
        [1.00000000000000000000, -6.58463710447905725687, 19.78395622714006307774, -35.25102529483660873666, 40.65848006889362409311, -31.06420861118791876265, 15.36350210136839322672, -4.50606515909752669558, 0.60305116861616880897, ],
        [1.00000000000000000000, -6.27328161979410481308, 18.22874596746645181611, -31.76073624057005062582, 36.17955693212973500295, -27.56016140698564953482, 13.72584795457170336874, -4.09890988924108157221, 0.56697613892051679230, ],
        [1.00000000000000000000, -5.89293402202941507539, 16.43262915096972065498, -27.86186570076494462000, 31.27576799440729971025, -23.75312777430866972850, 11.94340818088909195183, -3.65143362031520180011, 0.52825357114415927295, ],
        [1.00000000000000000000, -5.42948866411179853486, 14.39610145347021585849, -23.60996260002375635167, 26.05026148330158974886, -19.72226512198132652998, 10.04541505561078373887, -3.16477916825838923032, 0.48690695045300086408, ],
        [1.00000000000000000000, -4.86686551794541610860, 12.14581325135404732407, -19.11687410535671460821, 20.67879064123356869231, -15.59660096829638575855, 8.08449247725312147850, -2.64294781952877722020, 0.44304957457516985775, ],
        [1.00000000000000000000, -4.18746984031755520306, 9.75052481316909869236, -14.56039138341996874715, 15.41968435758045785633, -11.55707747348517955288, 6.14296361656817424546, -2.09399971869630618926, 0.39691718492073091440, ],
        [1.00000000000000000000, -3.37338897481042687687, 7.34164583260481595772, -10.17722229134588474153, 10.60947164619632943072, -7.82180187258662940053, 4.33659166697367659538, -1.53143677839180591960, 0.34890741728595076054, ],
        [1.00000000000000000000, -2.40890432104921936585, 5.13546240938036113732, -6.22034482648387410109, 6.63573070033134637669, -4.60212973807310365970, 2.81104856487811538557, -0.97555720740495588394, 0.29962468346251119877, ],
        [1.00000000000000000000, -1.28525462932482192890, 3.44767287152055512678, -2.85892813635323328469, 3.88619218602192351142, -2.02141805630013848827, 1.72358162462535413617, -0.45430538274270571009, 0.24992609730917114685, ],
        [1.00000000000000000000, -0.00908402653042375899, 2.67819216681267313618, -0.01824641254555868508, 2.68974676175003235556, -0.01221670862996817805, 1.20059128834247053064, -0.00272651927529454600, 0.20095874251454823312, ],
        [1.00000000000000000000, 1.38344571052198572758, 3.22417640702405261521, 2.76614693403818900919, 3.26964656449816803985, 1.73330614893778034435, 1.26595672453705598848, 0.34037857644001068280, 0.15417009095915737427, ],
        [1.00000000000000000000, 2.80474720272893041084, 5.26016068176120654698, 6.23859992733477142224, 5.65058135727640298285, 3.60307703783199650971, 1.75457458742522254269, 0.54032238446129121634, 0.11126168899029165171, ],
        [1.00000000000000000000, 4.08565293526205497443, 8.34627995370773589912, 10.65625099730778657658, 9.25177042278347272486, 5.55875338003177521529, 2.27111370635247711292, 0.57993639879205749477, 0.07404433906219023975, ],])

    b = np.array([
            [-0.00000012303328874874, -0.00000013653937055761, 0.00000125367207263811, -0.00000157303802325824, 0.00000049080465112789, 0.00000015829658433841, -0.00000007016262553981, ],
            [-0.00000018300290414348, -0.00000024572458069439, 0.00000192769301832275, -0.00000224355446582746, 0.00000054714725431149, 0.00000028808925147141, -0.00000009064757344032, ],
            [-0.00000027625224561648, -0.00000043343464874278, 0.00000300894874275542, -0.00000324287166173429, 0.00000054388791370928, 0.00000051552870491050, -0.00000011580680528165, ],
            [-0.00000042271275073732, -0.00000075260871402482, 0.00000475988112160461, -0.00000474891437482340, 0.00000039816965382722, 0.00000091124259845735, -0.00000014505753430365, ],
            [-0.00000065498840075791, -0.00000128946893723771, 0.00000762073681095033, -0.00000704567048370689, -0.00000005049828950841, 0.00000159564855046024, -0.00000017575925019965, ],
            [-0.00000102682741688902, -0.00000218198602129232, 0.00001233537993186039, -0.00001059276430714516, -0.00000110587886197127, 0.00000277309856614277, -0.00000020102189070539, ],
            [-0.00000162748779874857, -0.00000364538849056433, 0.00002016942817560112, -0.00001614468828985779, -0.00000333456992591421, 0.00000478832057816129, -0.00000020561424867751, ],
            [-0.00000260622013354422, -0.00000600247933205792, 0.00003329024768198367, -0.00002495763185744029, -0.00000778362079654594, 0.00000821817581739321, -0.00000015847137978850, ],
            [-0.00000421414170880032, -0.00000970619353653486, 0.00005543073544722159, -0.00003915189813353159, -0.00001637640916637087, 0.00001401710044183393, 0.00000000080665618212, ],
            [-0.00000687595545809233, -0.00001531369433078377, 0.00009304839676710114, -0.00006235150934148225, -0.00003263174195071744, 0.00002373859446836853, 0.00000038590984560613, ],
            [-0.00001131253025809117, -0.00002330071036932329, 0.00015733816333712912, -0.00010081611866861312, -0.00006296477899807728, 0.00003985036929870751, 0.00000120560565826826, ],
            [-0.00001874881094298364, -0.00003343754520151003, 0.00026767932845331646, -0.00016543654088466245, -0.00011901908420059737, 0.00006612753861044625, 0.00000283511416599083, ],
            [-0.00003126041510416853, -0.00004307190504492939, 0.00045737270916024035, -0.00027520354636463172, -0.00022177107895724710, 0.00010799969176047913, 0.00000593454455025720, ],
            [-0.00005233156256410688, -0.00004286842856792287, 0.00078267596597048224, -0.00046305186383226052, -0.00040850586515556539, 0.00017244468927282648, 0.00001163706487654691, ],
            [-0.00008769081982749049, -0.00000702876455155351, 0.00133551349415171258, -0.00078510102006873245, -0.00074390564303367795, 0.00026638567888362798, 0.00002182707444611402, ],
            [-0.00014636745998215640, 0.00012738992507560455, 0.00225693085842808153, -0.00133340296577178982, -0.00133538016355053916, 0.00039133172441348392, 0.00003949808138731572, ],
            [-0.00024138759464907461, 0.00049930949740199413, 0.00373800942986862207, -0.00224780513620336702, -0.00234746410890867381, 0.00053026857654867477, 0.00006906933594182423, ],
            [-0.00038783914379217024, 0.00138108000819991690, 0.00597053331571248229, -0.00370818689169356754, -0.00399409153887026261, 0.00062227272166735597, 0.00011623152877624650, ],
            [-0.00059148568295263606, 0.00321058170918516470, 0.00897093527353993135, -0.00585309402174502384, -0.00645144120458374624, 0.00052836726619058831, 0.00018613666036571946, ],
            [-0.00081208840220959363, 0.00640124687528421336, 0.01219525467865039368, -0.00851244523493160411, -0.00957920969236553815, 0.00003024091276867750, 0.00027700086280345104, ],
            [-0.00088486405681732967, 0.01041374856933248959, 0.01403328601563576250, -0.01063916133107999963, -0.01230105760909665398, -0.00098374821334038377, 0.00036179662536611415, ],])

    if verbose:
        import matplotlib.pyplot as plt
        for i in range(b.shape[0]):
            [w, h] = scipy.signal.freqz( b[i,:], a=a[i,:])
            plt.semilogx(w*(fs/2)/np.pi, 20*np.log10(h))
            plt.xlim(100, fs/2)

    if x is not None:
        y = np.zeros((b.shape[0], x.shape[0]))
        for i in range(b.shape[0]):
            y[i, :] = scipy.signal.lfilter(b[i,:], a[i,:], x)
        return y
    else:
        return b, a

    #plt.imshow(z, aspect='auto', origin='lower')
